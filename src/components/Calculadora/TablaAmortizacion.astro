<div class="container wow fadeInUp" style="margin-top: 4rem;" data-wow-delay="0.3s" id="tabla-credito">
  <div class="text-center mb-4">
    <h4 class="text-success">Tabla de Amortización</h4>
    <h1 class="display-5 mb-3" style="color: #004d40;">Detalle de pagos de tu crédito</h1>
    <p class="mb-0" style="color: #333;">Consulta el desglose de cada cuota y cómo disminuye tu saldo mes a mes.</p>
  </div>

  <!-- Resumen (IDs obligatorios) -->
  <div class="row justify-content-center mb-4">
    <div class="col-auto">
      <table class="table table-borderless mb-0">
        <tbody>
          <tr>
            <th class="text-end" style="color:#004d40;">Monto del préstamo</th>
            <td id="t-monto" class="fw-bold" style="color:#00d084;">—</td>
          </tr>
          <tr>
            <th class="text-end" style="color:#004d40;">Tasa por período</th>
            <td id="t-tasa">—</td>
          </tr>
          <tr>
            <th class="text-end" style="color:#004d40;">Plazo del préstamo</th>
            <td id="t-plazo">—</td>
          </tr>
          <tr>
            <th class="text-end" style="color:#004d40;">Frecuencia de pagos</th>
            <td id="t-frecuencia">—</td>
          </tr>
          <tr>
            <th class="text-end" style="color:#004d40;">Cuota Fija</th>
            <td id="t-cuota" class="fw-bold" style="color:#00d084;">—</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Detalle -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center shadow-sm" style="background:#fff;">
      <thead style="background: #00d084;">
        <tr style="color: #fff;">
          <th>Periodo</th>
          <th>Saldo inicial</th>
          <th>Cuota Fija</th>
          <th>Interés</th>
          <th>Abono a Capital</th>
          <th>Saldo Final</th>
        </tr>
      </thead>
      <tbody id="amort-body">
        <tr><td colspan="6" class="text-muted">Calcula tu crédito para ver el detalle…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { fmtCOP, fmtPct } from '/js/credito-core.js';

  const capitalizar = s => s ? s[0].toUpperCase()+s.slice(1) : '';

  // Nos suscribimos cuando el DOM ya está
  window.addEventListener('DOMContentLoaded', () => {
    window.addEventListener('credito:calculado', ({ detail }) => {
      // Re-seleccionamos SIEMPRE para evitar null
      const tMonto = document.getElementById('t-monto');
      const tTasa = document.getElementById('t-tasa');
      const tPlazo = document.getElementById('t-plazo');
      const tFrecuencia = document.getElementById('t-frecuencia');
      const tCuota = document.getElementById('t-cuota');
      const body = document.getElementById('amort-body');

      if (!tMonto || !tTasa || !tPlazo || !tFrecuencia || !tCuota || !body) {
        console.warn('IDs de la tabla no encontrados; revisa que el HTML tenga t-monto/t-tasa/t-plazo/t-frecuencia/t-cuota/amort-body.');
        return;
      }

      const { resumen, filas } = detail;

      // Resumen
      tMonto.textContent = fmtCOP(resumen.monto);
      tTasa.textContent = fmtPct(resumen.tasaPeriodo);
      tPlazo.textContent = `${resumen.mesesTotal} meses • ${resumen.cuotas} cuotas (${resumen.mesesPorPeriodo} m/periodo)`;
      tFrecuencia.textContent = capitalizar(resumen.periodicidad);
      tCuota.textContent = fmtCOP(resumen.cuota);

      // Detalle
      let rows = `
        <tr style="background:#f9f9f9;">
          <td>0</td>
          <td>${fmtCOP(resumen.monto)}</td>
          <td></td><td></td><td></td>
          <td>${fmtCOP(resumen.monto)}</td>
        </tr>`;
      let saldoAnterior = resumen.monto;
      filas.forEach((f, i) => {
        const bg = i % 2 ? '#f9f9f9' : '#fff';
        rows += `
          <tr style="background:${bg};">
            <td>${f.k}</td>
            <td>${fmtCOP(saldoAnterior)}</td>
            <td>${fmtCOP(f.cuota)}</td>
            <td>${fmtCOP(f.interes)}</td>
            <td>${fmtCOP(f.abono)}</td>
            <td>${fmtCOP(f.saldo)}</td>
          </tr>`;
        saldoAnterior = f.saldo;
      });
      body.innerHTML = rows;
    });
  });
</script>
