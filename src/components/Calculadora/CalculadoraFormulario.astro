---
---

<div class="bg-white p-5 rounded shadow wow fadeInUp" data-wow-delay="0.2s">

  <h4 class="text-success mb-4">Ingresa tus Datos</h4>
  <form>
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="form-floating">
          <input type="text" class="form-control border-0" id="nombre" placeholder="Nombre" style="background-color: #e8f5e9" />
          <label for="nombre" style="color: #004d40">Nombre</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <input type="text" class="form-control border-0" id="apellido" placeholder="Apellido" style="background-color: #e8f5e9" />
          <label for="apellido" style="color: #004d40">Apellido</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <select class="form-select border-0" id="tipoDocumento" style="background-color: #e8f5e9">
            <option value="CC">Cédula de Ciudadanía</option>
            <option value="CE">Cédula de Extranjería</option>
            <option value="NIT">NIT</option>
          </select>
          <label for="tipoDocumento" style="color: #004d40">Tipo de Documento</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <input type="text" class="form-control border-0" id="cedula" placeholder="Número de Documento" style="background-color: #e8f5e9" />
          <label for="cedula" style="color: #004d40">Número de Documento</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <input type="email" class="form-control border-0" id="correo" placeholder="Correo Electrónico" style="background-color: #e8f5e9" />
          <label for="correo" style="color: #004d40">Correo Electrónico</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <input type="tel" class="form-control border-0" id="telefono" placeholder="Teléfono" style="background-color: #e8f5e9" />
          <label for="telefono" style="color: #004d40">Teléfono</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <input type="number" class="form-control border-0" id="ingresos" placeholder="Ingresos Mensuales" style="background-color: #e8f5e9" />
          <label for="ingresos" style="color: #004d40">Ingresos Mensuales</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <input type="number" class="form-control border-0" id="monto" placeholder="Monto Solicitado" style="background-color: #e8f5e9" />
          <label for="monto" style="color: #004d40">Monto Solicitado</label>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-floating">
          <select class="form-select border-0" id="frecuenciaCuotas" style="background-color: #e8f5e9">
            <option value="12">1 Año (12 meses)</option>
            <option value="24">2 Años (24 meses)</option>
            <option value="36">3 Años (36 meses)</option>
            <option value="48">4 Años (48 meses)</option>
            <option value="60">5 Años (60 meses)</option>
          </select>
          <label for="frecuenciaCuotas" style="color: #004d40">Tiempo del credito</label>
        </div>
      </div>
      <div class="col-12">
        <div class="form-floating">
          <textarea class="form-control border-0" placeholder="Comentarios" id="comentarios" style="height: 120px; background-color: #e8f5e9"></textarea>
          <label for="comentarios" style="color: #004d40">Comentarios</label>
        </div>
      </div>
      <div class="col-12">
        <button class="btn btn-success w-100 py-3" style="background-color: #00d084; color: #fff">
          Calcular Crédito
        </button>
      </div>
    </div>
  </form>
</div>

<script type="module">
  import { calcularDesdeFormulario } from '/js/credito-core.js';

  // Utilidades para máscara COP
  const unformatCOP = (s) => (s || '').toString().replace(/\D+/g, '');
  const formatCOP   = (digits) => {
    const d = unformatCOP(digits);
    if (!d) return '';
    return '$' + d.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  };

  window.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.bg-white form') || document.querySelector('form');
    if (!form) return;

    // === A) Agregar campos nuevos (sin tocar lo demás) ===
    // A.1 Fecha de nacimiento + Sexo (después de Teléfono)
    if (!document.getElementById('fechaNacimiento') && !document.getElementById('sexo')) {
      const telCol = form.querySelector('#telefono')?.closest('.col-lg-6, .col-md-6, .col-12');
      const fechaCol = document.createElement('div');
      fechaCol.className = 'col-lg-6';
      fechaCol.innerHTML = `
        <div class="form-floating">
          <input type="date" class="form-control border-0" id="fechaNacimiento"
                 placeholder="Fecha de nacimiento" style="background-color:#e8f5e9" />
          <label for="fechaNacimiento" style="color:#004d40">Fecha de nacimiento</label>
        </div>`;
      const sexoCol = document.createElement('div');
      sexoCol.className = 'col-lg-6';
      sexoCol.innerHTML = `
        <div class="form-floating">
          <select class="form-select border-0" id="sexo" style="background-color:#e8f5e9">
            <option value="">Selecciona…</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
          <label for="sexo" style="color:#004d40">Sexo</label>
        </div>`;
      if (telCol) {
        telCol.insertAdjacentElement('afterend', fechaCol);
        fechaCol.insertAdjacentElement('afterend', sexoCol);
      } else {
        const row = form.querySelector('.row.g-4') || form;
        row.appendChild(fechaCol);
        row.appendChild(sexoCol);
      }
    }

    // A.2 Actividad económica (después de Monto)
    if (!document.getElementById('actividadEconomica')) {
      const montoCol = form.querySelector('#monto')?.closest('.col-lg-6, .col-md-6, .col-12');
      const actCol = document.createElement('div');
      actCol.className = 'col-lg-6';
      actCol.innerHTML = `
        <div class="form-floating">
          <select class="form-select border-0" id="actividadEconomica" style="background-color:#e8f5e9">
            <option value="">Selecciona actividad…</option>
            <option value="Ganaderia">Ganadería</option>
            <option value="Avicola">Avícola (Gallinas)</option>
            <option value="Piscicultura">Piscicultura</option>
            <option value="Agricola">Agrícola (sembrar y recolectar)</option>
            <option value="Porcicultura">Porcicultura</option>
            <option value="Caficultor">Caficultor</option>
          </select>
          <label for="actividadEconomica" style="color:#004d40">Actividad económica</label>
        </div>`;
      if (montoCol) {
        montoCol.insertAdjacentElement('afterend', actCol);
      } else {
        (form.querySelector('.row.g-4') || form).appendChild(actCol);
      }
    }

    // === B) Máscara COP en #ingresos y #monto (solo UI, tu parseNumberSafe los lee bien) ===
    ['#ingresos', '#monto'].forEach((sel) => {
      const inp = form.querySelector(sel);
      if (!inp) return;
      // permitimos $ y puntos → cambiamos a text
      inp.type = 'text';
      inp.inputMode = 'numeric';
      inp.autocomplete = 'off';
      if (inp.value) inp.value = formatCOP(inp.value);

      const placeEnd = (el) => {
        const L = el.value.length;
        requestAnimationFrame(() => el.setSelectionRange(L, L));
      };

      inp.addEventListener('input', () => {
        const raw = unformatCOP(inp.value);
        inp.dataset.raw = raw;            // opcional, por si lo quieres leer crudo
        inp.value = formatCOP(raw);
        placeEnd(inp);
      });

      inp.addEventListener('blur', () => {
        inp.value = formatCOP(inp.dataset.raw || inp.value);
      });

      inp.addEventListener('focus', () => placeEnd(inp));
    });

    // === C) Tu código existente para PERIODICIDAD y submit (SIN CAMBIOS) ===
    if (!document.getElementById('periodicidad')) {
      const duracionCol = document.querySelector('#frecuenciaCuotas')?.closest('.col-lg-6, .col-md-6, .col-12');

      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-6';
      col.innerHTML = `
        <div class="form-floating">
          <select class="form-select border-0" id="periodicidad" style="background-color:#e8f5e9">
            <option value="">Selecciona periodicidad…</option>
            <option value="mensual">Mensual (1,57%)</option>
            <option value="trimestral">Trimestral (4,77%)</option>
            <option value="cuatrimestral">Cuatrimestral (6,41%)</option>
            <option value="semestral">Semestral (9,77%)</option>
            <option value="anual">Anual (21,26%)</option>
          </select>
          <label for="periodicidad" style="color:#004d40">Periodicidad de pagos</label>
        </div>
      `;
      if (duracionCol) {
        duracionCol.insertAdjacentElement('afterend', col);
      } else {
        (form.querySelector('.row.g-4') || form).appendChild(col);
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      try {
        // Extraer manualmente todos los valores del formulario
        const solicitud = {
          nombre: form.nombre?.value || "",
          apellido: form.apellido?.value || "",
          tipo_documento: form.tipoDocumento?.value || "",
          numero_documento: form.cedula?.value || "",
          correo: form.correo?.value || "",
          telefono: form.telefono?.value || "",
          ingresos_mensuales: form.ingresos?.dataset.raw || "", // Usar el valor sin formato
          monto_solicitado: form.monto?.dataset.raw || "",
          banco: form.banco?.value || "", // Ajusta si tienes un campo banco
          tiempo_credito_meses: Number(form.frecuenciaCuotas?.value) || 0,
          periodicidad_pagos: form.periodicidad?.value || "",
          fecha_nacimiento: form.fechaNacimiento?.value || "",
          sexo: form.sexo?.value || "",
          actividad_economica: form.actividadEconomica?.value || "",
          comentarios: form.comentarios?.value || ""
        };

        console.log("SolicitudCreate payload:", JSON.stringify(solicitud, null, 2));

        window.dispatchEvent(new CustomEvent('credito:calculado', { detail: solicitud }));
        document.getElementById('amort-body')?.closest('.container')?.scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        alert(err?.message || 'No se pudo calcular el crédito.');
      }
    });
  });
</script>
